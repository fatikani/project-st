{% extends "base.html" %}

{% block page_title %}Analysis Results{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-file-earmark-check"></i> Analysis Results: {{ filename }}
                </h6>
            </div>
            <div class="card-body">
                {% if status == 'completed' %}
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> Analysis completed successfully!
                    </div>
                    
                    <!-- Metadata Section -->
                    {% if analysis_data.metadata %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-info-circle"></i> Video Metadata</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm">
                                        <tr><td><strong>File Name:</strong></td><td>{{ analysis_data.metadata.filename }}</td></tr>
                                        <tr><td><strong>File Size:</strong></td><td>{{ "%.2f"|format(analysis_data.metadata.file_size / (1024*1024)) }} MB</td></tr>
                                        <tr><td><strong>SHA-256 Hash:</strong></td><td><code>{{ analysis_data.metadata.file_hash[:16] }}...</code></td></tr>
                                        <tr><td><strong>Frame Count:</strong></td><td>{{ analysis_data.metadata.frame_count }}</td></tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-sm">
                                        <tr><td><strong>FPS:</strong></td><td>{{ "%.2f"|format(analysis_data.metadata.fps) }}</td></tr>
                                        <tr><td><strong>Duration:</strong></td><td>{{ analysis_data.metadata.duration }} seconds</td></tr>
                                        <tr><td><strong>Resolution:</strong></td><td>{{ analysis_data.metadata.width }}x{{ analysis_data.metadata.height }}</td></tr>
                                        <tr><td><strong>Analysis Date:</strong></td><td>{{ analysis_data.metadata.analysis_timestamp[:19] }}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Motion Detection Results -->
                    {% if analysis_data.motion_detection %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-activity"></i> Motion Detection Analysis</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="motionChart" width="400" height="200"></canvas>
                            <div class="mt-3">
                                <p><strong>Motion Summary:</strong></p>
                                <ul>
                                    <li>Total frames analyzed: {{ analysis_data.motion_detection|length }}</li>
                                    <li>High motion frames: {{ analysis_data.motion_detection|selectattr("motion_percentage", "gt", 5)|list|length }}</li>
                                    <li>Average motion: {{ "%.2f"|format((analysis_data.motion_detection|sum(attribute="motion_percentage")) / (analysis_data.motion_detection|length)) }}%</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Frame Analysis Results -->
                    {% if analysis_data.frame_analysis %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-image"></i> Frame Quality Analysis</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="qualityChart" width="400" height="200"></canvas>
                            <div class="mt-3">
                                <p><strong>Quality Summary:</strong></p>
                                <ul>
                                    <li>Frames analyzed: {{ analysis_data.frame_analysis|length }}</li>
                                    <li>Good quality frames: {{ analysis_data.frame_analysis|selectattr("frame_quality", "equalto", "good")|list|length }}</li>
                                    <li>Poor quality frames: {{ analysis_data.frame_analysis|selectattr("frame_quality", "equalto", "poor")|list|length }}</li>
                                    <li>Average blur measure: {{ "%.2f"|format((analysis_data.frame_analysis|sum(attribute="blur_measure")) / (analysis_data.frame_analysis|length)) }}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Actions -->
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="generateReport()">
                            <i class="bi bi-file-earmark-pdf"></i> Generate PDF Report
                        </button>
                        <button class="btn btn-secondary" onclick="exportData()">
                            <i class="bi bi-download"></i> Export Raw Data
                        </button>
                        <button class="btn btn-info" onclick="shareResults()">
                            <i class="bi bi-share"></i> Share Results
                        </button>
                        <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                            <i class="bi bi-house"></i> Back to Dashboard
                        </a>
                    </div>
                    
                {% elif status == 'failed' %}
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Analysis failed. Please try uploading the file again.
                    </div>
                    <a href="{{ url_for('upload_video') }}" class="btn btn-primary">
                        <i class="bi bi-cloud-upload"></i> Upload Another File
                    </a>
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-hourglass-split"></i> Analysis is still in progress. Please refresh the page in a few moments.
                    </div>
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Report Generation Modal -->
<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generate Analysis Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="reportTitle" class="form-label">Report Title</label>
                        <input type="text" class="form-control" id="reportTitle" value="Forensic Video Analysis Report">
                    </div>
                    <div class="mb-3">
                        <label for="investigator" class="form-label">Investigator Name</label>
                        <input type="text" class="form-control" id="investigator" placeholder="Enter investigator name">
                    </div>
                    <div class="mb-3">
                        <label for="caseRef" class="form-label">Case Reference</label>
                        <input type="text" class="form-control" id="caseRef" placeholder="Enter case reference">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Include Sections:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeMetadata" checked>
                            <label class="form-check-label" for="includeMetadata">Video Metadata</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeMotion" checked>
                            <label class="form-check-label" for="includeMotion">Motion Analysis</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeQuality" checked>
                            <label class="form-check-label" for="includeQuality">Quality Assessment</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="downloadReport()">Generate Report</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
{% if analysis_data.motion_detection %}
// Motion Detection Chart
const motionCtx = document.getElementById('motionChart').getContext('2d');
const motionData = {{ analysis_data.motion_detection|tojson }};

new Chart(motionCtx, {
    type: 'line',
    data: {
        labels: motionData.map(d => Math.round(d.timestamp)),
        datasets: [{
            label: 'Motion Percentage',
            data: motionData.map(d => d.motion_percentage),
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Time (seconds)'
                }
            },
            y: {
                title: {
                    display: true,
                    text: 'Motion Percentage'
                },
                beginAtZero: true
            }
        }
    }
});
{% endif %}

{% if analysis_data.frame_analysis %}
// Frame Quality Chart
const qualityCtx = document.getElementById('qualityChart').getContext('2d');
const qualityData = {{ analysis_data.frame_analysis|tojson }};

new Chart(qualityCtx, {
    type: 'scatter',
    data: {
        datasets: [{
            label: 'Blur Measure',
            data: qualityData.map(d => ({x: d.timestamp, y: d.blur_measure})),
            backgroundColor: qualityData.map(d => d.frame_quality === 'good' ? 'rgba(75, 192, 192, 0.6)' : 'rgba(255, 99, 132, 0.6)')
        }]
    },
    options: {
        responsive: true,
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Time (seconds)'
                }
            },
            y: {
                title: {
                    display: true,
                    text: 'Blur Measure (higher = sharper)'
                },
                beginAtZero: true
            }
        }
    }
});
{% endif %}

function generateReport() {
    const modal = new bootstrap.Modal(document.getElementById('reportModal'));
    modal.show();
}

function downloadReport() {
    // Simulate report generation
    alert('Report generation started. You will receive a download link shortly.');
    bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();
}

function exportData() {
    const data = {{ analysis_data|tojson }};
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'analysis_data_{{ evidence_id }}.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function shareResults() {
    if (navigator.share) {
        navigator.share({
            title: 'Forensic Video Analysis Results',
            text: 'Video analysis completed for {{ filename }}',
            url: window.location.href
        });
    } else {
        // Fallback - copy link to clipboard
        navigator.clipboard.writeText(window.location.href).then(() => {
            alert('Link copied to clipboard!');
        });
    }
}
</script>
{% endblock %}